{% extends "base.html" %}
{% block title %}Queries â€” CampusManager{% endblock %}
{% block sidebar_content %}
    <div class="bg-white rounded-2xl p-6 border border-gray-100 shadow-sm w-full">
        <h3 class="font-bold text-text-dark mb-4 flex items-center gap-2">
            <i data-feather="filter" class="w-4 h-4 text-primary"></i> Filter Queries
        </h3>
        <form method="get" class="space-y-4">
            <!-- Category -->
            <div class="space-y-2">
                <label class="text-xs font-bold text-text-light uppercase tracking-wide">Category</label>
                <div class="relative">
                    <select name="tag"
                            onchange="this.form.submit()"
                            class="w-full pl-4 pr-10 py-3 rounded-xl bg-gray-50 border-transparent focus:bg-white focus:border-primary focus:ring-4 focus:ring-primary/10 transition-all font-medium text-text-dark appearance-none cursor-pointer text-sm">
                        <option value="">All Categories</option>
                        {% for tag in QueryTag %}
                            <option value="{{ tag.name }}"
                                    {% if request.args.get('tag') == tag.name %}selected{% endif %}>
                                {{ tag.value }}
                            </option>
                        {% endfor %}
                    </select>
                    <i data-feather="chevron-down"
                       class="w-4 h-4 text-text-light absolute right-4 top-3.5 pointer-events-none"></i>
                </div>
            </div>
            <!-- Role -->
            <div class="space-y-2">
                <label class="text-xs font-bold text-text-light uppercase tracking-wide">User Role</label>
                <div class="relative">
                    <select name="role"
                            onchange="this.form.submit()"
                            class="w-full pl-4 pr-10 py-3 rounded-xl bg-gray-50 border-transparent focus:bg-white focus:border-primary focus:ring-4 focus:ring-primary/10 transition-all font-medium text-text-dark appearance-none cursor-pointer text-sm">
                        <option value="">All Users</option>
                        <option value="STUDENT"
                                {% if request.args.get('role') == 'STUDENT' %}selected{% endif %}>Students</option>
                        <option value="TEACHER"
                                {% if request.args.get('role') == 'TEACHER' %}selected{% endif %}>Teachers</option>
                    </select>
                    <i data-feather="chevron-down"
                       class="w-4 h-4 text-text-light absolute right-4 top-3.5 pointer-events-none"></i>
                </div>
            </div>
            <!-- Sort -->
            <div class="space-y-2">
                <label class="text-xs font-bold text-text-light uppercase tracking-wide">Sort Order</label>
                <div class="relative">
                    <select name="sort"
                            onchange="this.form.submit()"
                            class="w-full pl-4 pr-10 py-3 rounded-xl bg-gray-50 border-transparent focus:bg-white focus:border-primary focus:ring-4 focus:ring-primary/10 transition-all font-medium text-text-dark appearance-none cursor-pointer text-sm">
                        <option value="desc"
                                {% if request.args.get('sort') != 'asc' %}selected{% endif %}>Newest First</option>
                        <option value="asc"
                                {% if request.args.get('sort') == 'asc' %}selected{% endif %}>Oldest First</option>
                    </select>
                    <i data-feather="chevron-down"
                       class="w-4 h-4 text-text-light absolute right-4 top-3.5 pointer-events-none"></i>
                </div>
            </div>
            {% if request.args.get('tag') or request.args.get('role') or request.args.get('sort') == 'asc' %}
                <div class="pt-2">
                    <a href="{{ url_for("views.admin_queries") }}"
                       class="w-full py-2.5 rounded-xl bg-red-50 text-red-600 font-bold hover:bg-red-100 transition-colors flex items-center justify-center gap-2 text-sm">
                        <i data-feather="x" class="w-4 h-4"></i> Clear Filters
                    </a>
                </div>
            {% endif %}
        </form>
    </div>
{% endblock %}
{% block content %}
    <div class="max-w-7xl mx-auto space-y-6">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold text-text-dark">User Queries</h1>
                <p class="text-text-light mt-1">Manage and respond to support tickets from students and teachers.</p>
            </div>
        </div>
        <!-- Queries List -->
        <div class="space-y-2">
            {% for query in queries %}
                <div class="bg-white border border-gray-100 rounded-xl overflow-hidden shadow-sm hover:shadow-md transition-shadow">
                    <!-- Summary Header (Clickable) -->
                    <div class="p-3 flex items-center justify-between cursor-pointer hover:bg-gray-50/50 transition-colors"
                         onclick="toggleQuery('{{ query.id }}')">
                        <div class="flex items-center gap-3 overflow-hidden">
                            <!-- Category Badge -->
                            <span class="px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wider bg-gray-100 text-text-light whitespace-nowrap">
                                {{ query.tag.value }}
                            </span>
                            <!-- Title -->
                            <span class="font-bold text-sm text-text-dark truncate">{{ query.title }}</span>
                            <!-- Sender -->
                            <span class="text-xs text-text-light truncate hidden sm:inline-block border-l border-gray-200 pl-3">
                                <span class="font-medium text-text-dark">{{ query.user.name }}</span> ({{ query.user.role.name|title }})
                            </span>
                        </div>
                        <div class="flex items-center gap-3 shrink-0">
                            <span class="text-xs text-text-light font-medium">{{ query.created_at.strftime("%b %d") }}</span>
                            <div class="w-6 h-6 rounded-full bg-gray-50 flex items-center justify-center transition-transform duration-200"
                                 id="chevron-{{ query.id }}">
                                <i data-feather="chevron-down" class="w-3 h-3 text-text-light"></i>
                            </div>
                        </div>
                    </div>
                    <!-- Expanded Details -->
                    <div id="content-{{ query.id }}"
                         class="hidden border-t border-gray-100 bg-gray-50/30">
                        <div class="p-4 space-y-4">
                            <!-- Description -->
                            <div class="text-sm text-text-dark leading-relaxed bg-white p-3 rounded-lg border border-gray-100">
                                {{ query.description }}
                            </div>
                            <!-- Metadata Grid -->
                            <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 text-xs">
                                <div>
                                    <span class="block font-bold text-text-light uppercase tracking-wide text-[10px] mb-0.5">From</span>
                                    <span class="font-medium text-text-dark">{{ query.user.name }}</span>
                                </div>
                                <div>
                                    <span class="block font-bold text-text-light uppercase tracking-wide text-[10px] mb-0.5">Email</span>
                                    <span class="font-medium text-text-dark">{{ query.user.email }}</span>
                                </div>
                                <div>
                                    <span class="block font-bold text-text-light uppercase tracking-wide text-[10px] mb-0.5">Role</span>
                                    <span class="font-medium text-text-dark">{{ query.user.role.name }}</span>
                                </div>
                                <div>
                                    <span class="block font-bold text-text-light uppercase tracking-wide text-[10px] mb-0.5">Dep/Branch</span>
                                    <span class="font-medium text-text-dark">{{ query.user.department or query.user.branch.name or 'N/A' }}</span>
                                </div>
                            </div>
                            <!-- Action Form -->
                            <form action="{{ url_for('views.resolve_query', query_id=query.id) }}"
                                  method="post"
                                  class="flex flex-col sm:flex-row gap-3 pt-2 border-t border-gray-100">
                                <div class="flex-1">
                                    <textarea name="response"
                                              rows="1"
                                              class="w-full bg-white border border-gray-200 rounded-lg px-3 py-2 text-sm text-text-dark focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary transition-all resize-none"
                                              placeholder="Type a reply (Optional)..."></textarea>
                                </div>
                                <div class="flex items-center gap-2 shrink-0 self-end sm:self-auto">
                                    <button type="submit"
                                            name="action"
                                            value="dismiss"
                                            class="px-4 py-2 rounded-lg bg-white border border-gray-200 text-text-dark text-xs font-bold hover:bg-gray-50 transition-colors">
                                        Dismiss
                                    </button>
                                    <button type="submit"
                                            name="action"
                                            value="resolve"
                                            class="px-4 py-2 rounded-lg bg-primary text-white text-xs font-bold hover:bg-primary-dark shadow-sm hover:shadow transition-all flex items-center gap-1.5">
                                        <i data-feather="check-circle" class="w-3 h-3"></i> Resolve & Reply
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            {% else %}
                <div class="text-center py-12 bg-white rounded-2xl border border-gray-100 border-dashed">
                    <div class="w-12 h-12 bg-gray-50 rounded-full flex items-center justify-center mx-auto mb-3 text-gray-300">
                        <i data-feather="inbox" class="w-6 h-6"></i>
                    </div>
                    <h3 class="text-sm font-bold text-text-dark">No queries found</h3>
                    <p class="text-xs text-text-light">Great job! All caught up.</p>
                </div>
            {% endfor %}
        </div>
    </div>
    <script>
    document.addEventListener("DOMContentLoaded", function () {
        if (typeof feather !== "undefined") {
            feather.replace();
        }
    });

    function toggleQuery(id) {
        const content = document.getElementById(`content-${id}`);
        const chevron = document.getElementById(`chevron-${id}`);
        
        if (content.classList.contains('hidden')) {
            content.classList.remove('hidden');
            chevron.style.transform = 'rotate(180deg)';
        } else {
            content.classList.add('hidden');
            chevron.style.transform = 'rotate(0deg)';
        }
    }
    </script>
{% endblock %}
