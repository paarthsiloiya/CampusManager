{% extends "base.html" %} {% block title %}Assign Classes{% endblock %} {% block sidebar_content %}
<div class="flex flex-col h-[32rem] lg:h-full w-full bg-white rounded-2xl p-4 border border-gray-100 lg:border-none lg:p-0 lg:bg-transparent lg:shadow-none shadow-sm">
    <div class="flex items-center justify-between mb-4 flex-shrink-0">
        <h2 class="text-lg font-bold text-text-dark">Current Assignments</h2>
        <span class="bg-primary/10 text-primary text-xs font-bold px-2.5 py-1 rounded-full">{{ assignments|length }}</span>
    </div>

    <!-- Search Assignments -->
    <div class="relative mb-4 flex-shrink-0">
        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
            <i data-feather="search" class="h-4 w-4 text-text-light"></i>
        </div>
        <input type="text" id="assignmentSearchInput" placeholder="Search assignments..." class="pl-10 w-full bg-gray-50 border border-transparent focus:bg-white focus:border-primary focus:ring-2 focus:ring-primary/20 rounded-xl py-2 text-sm text-text-dark transition-all placeholder-gray-400" />
    </div>

    <!-- Assignments List -->
    <div class="overflow-y-auto flex-1 pr-1 space-y-3 custom-scrollbar" id="assignmentsList">
        {% for assignment in assignments %}
        <div class="assignment-card bg-white border border-gray-100 lg:border-gray-200 rounded-xl p-3 hover:shadow-md transition-all relative group" data-search="{{ assignment.teacher.name }} {{ assignment.subject.name }} {{ assignment.subject.code }} {{ assignment.subject.branch }}">
            <div class="flex justify-between items-start mb-1">
                <div class="overflow-hidden">
                    <h3 class="font-bold text-text-dark text-sm truncate">{{ assignment.teacher.name }}</h3>
                    <div class="text-xs text-primary font-bold mt-0.5">{{ assignment.subject.branch }}: {{ assignment.subject.code.split('-', 1)[1] if '-' in assignment.subject.code else assignment.subject.code }}</div>
                </div>
                <form action="{{ url_for('views.delete_assignment', id=assignment.id) }}" method="POST" onsubmit="return confirm('Remove assignment for {{ assignment.subject.code }} from {{ assignment.teacher.name }}?');" class="flex-shrink-0 ml-2">
                    <button type="submit" class="text-gray-300 hover:text-red-500 p-1 rounded-lg hover:bg-red-50 transition-colors" title="Remove Assignment">
                        <i data-feather="trash-2" class="w-4 h-4"></i>
                    </button>
                </form>
            </div>

            <div class="text-xs text-text-light font-medium mb-2 truncate">{{ assignment.subject.name }}</div>

            <div class="flex items-center justify-between mt-2 pt-2 border-t border-dashed border-gray-100">
                <span class="inline-flex items-center px-1.5 py-0.5 rounded text-xs font-bold bg-gray-50 text-text-light">Sem {{ assignment.subject.semester }} </span>
                {% if assignment.section %}
                <span class="text-xs text-text-light flex items-center gap-1 font-medium bg-gray-50 px-1.5 py-0.5 rounded"> <i data-feather="users" class="w-3 h-3"></i> {{ assignment.section }} </span>
                {% endif %}
            </div>
        </div>
        {% else %}
        <div class="text-center py-8 text-text-light text-sm flex flex-col items-center">
            <div class="w-10 h-10 bg-gray-50 rounded-full flex items-center justify-center mb-2">
                <i data-feather="inbox" class="w-5 h-5 opacity-50"></i>
            </div>
            No classes assigned yet.
        </div>
        {% endfor %}
        <div id="noAssignmentsFound" class="hidden text-center text-text-light text-sm py-4">No assignments found</div>
    </div>
</div>
{% endblock %} {% block content %}
<div class="max-w-5xl mx-auto flex flex-col h-full">
    <!-- Header -->
    <div class="flex flex-col md:flex-row items-start md:items-center justify-between mb-6 gap-4">
        <div class="flex-1 min-w-0">
            <h1 class="text-lg md:text-2xl font-bold text-text-dark truncate">Class Assignment</h1>
            <p class="text-text-light text-xs md:text-sm mt-1 truncate">Manage teacher subject allocations.</p>
        </div>

        <a href="{{ url_for('views.admin_dashboard') }}" class="inline-flex items-center justify-center md:justify-start gap-2 text-sm font-bold text-text-light hover:text-primary transition-colors bg-transparent px-3 py-2 rounded-lg w-full md:w-auto">
            <i data-feather="arrow-left" class="w-4 h-4"></i>
            <span class="sm:inline">Back to Dashboard</span>
        </a>
    </div>

    <!-- Main Card -->
    <div class="bg-white rounded-3xl border border-gray-100 shadow-sm flex flex-col overflow-hidden max-h-[calc(100vh-12rem)]">
        <div class="p-2 border-b border-gray-100 flex-shrink-0">
            <h2 class="font-bold text-text-dark flex items-center gap-2">
                <span class="w-8 h-8 rounded-lg bg-primary/10 text-primary flex items-center justify-center">
                    <i data-feather="plus-circle" class="w-4 h-4"></i>
                </span>
                Assign New Class
            </h2>
        </div>

        <div class="p-4 overflow-hidden flex flex-col flex-1">
            <form action="{{ url_for('views.assign_class') }}" method="POST" class="flex flex-col h-full space-y-5">
                <!-- Teacher Selection -->
                <div class="flex-shrink-0 space-y-2">
                    <label for="teacher_id" class="text-xs font-bold text-text-dark uppercase tracking-wide">Select Teacher</label>
                    <div class="relative">
                        <select name="teacher_id" id="teacher_id" required class="w-full appearance-none bg-gray-50 border border-transparent rounded-xl px-4 py-3 text-text-dark font-medium focus:bg-white focus:border-primary focus:ring-2 focus:ring-primary/10 transition-all cursor-pointer">
                            <option value="">-- Choose a Faculty Member --</option>
                            {% for teacher in teachers %}
                            <option value="{{ teacher.id }}">{{ teacher.name }} ({{ teacher.department or 'No Dept' }})</option>
                            {% endfor %}
                        </select>
                        <i data-feather="chevron-down" class="w-4 h-4 text-text-light absolute right-4 top-3.5 pointer-events-none"></i>
                    </div>
                </div>

                <!-- Subject Selection Area -->
                <div class="flex flex-col flex-1 min-h-0 space-y-2">
                    <label class="text-xs font-bold text-text-dark uppercase tracking-wide">Select Subjects</label>

                    <!-- Subject Filters -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-3 mb-2 flex-shrink-0">
                        <div class="relative">
                            <select id="branchFilter" class="w-full appearance-none bg-gray-50 border border-transparent rounded-xl px-3 py-2 text-sm text-text-dark font-medium focus:bg-white focus:border-primary focus:ring-2 focus:ring-primary/10 transition-all cursor-pointer">
                                <option value="">All Branches</option>
                                {% for branch in grouped_subjects.keys() %}
                                <option value="{{ branch }}">{{ branch }}</option>
                                {% endfor %}
                            </select>
                            <i data-feather="filter" class="w-3 h-3 text-text-light absolute right-3 top-3 pointer-events-none"></i>
                        </div>

                        <div class="relative">
                            <select id="semesterFilter" class="w-full appearance-none bg-gray-50 border border-transparent rounded-xl px-3 py-2 text-sm text-text-dark font-medium focus:bg-white focus:border-primary focus:ring-2 focus:ring-primary/10 transition-all cursor-pointer">
                                <option value="">All Semesters</option>
                                {% for i in range(1, 9) %}
                                <option value="{{ i }}">Semester {{ i }}</option>
                                {% endfor %}
                            </select>
                            <i data-feather="calendar" class="w-3 h-3 text-text-light absolute right-3 top-3 pointer-events-none"></i>
                        </div>

                        <div class="relative md:col-span-2">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i data-feather="search" class="h-3 w-3 text-text-light"></i>
                            </div>
                            <input
                                type="text"
                                id="subjectSearchInput"
                                placeholder="Filter by code or name..."
                                class="pl-9 w-full bg-gray-50 border border-transparent rounded-xl px-3 py-2 text-sm text-text-dark font-medium focus:bg-white focus:border-primary focus:ring-2 focus:ring-primary/10 transition-all"
                            />
                        </div>
                    </div>

                    <!-- Scrollable Subject List -->
                    <div class="flex-1 overflow-y-auto border border-gray-100 rounded-xl bg-gray-50/50 px-2 py-0 custom-scrollbar" id="subjectListContainer">
                        {% for branch, subjects in grouped_subjects.items() %}
                        <div class="branch-group mb-2" data-branch="{{ branch }}">
                            <div class="sticky top-0 z-10 bg-gray-50/95 backdrop-blur-sm p-1.5 mb-1 rounded-lg border-b border-gray-100/50">
                                <h3 class="font-bold text-xs text-text-light uppercase tracking-wider flex items-center gap-2">
                                    <span class="w-1.5 h-1.5 rounded-full bg-primary"></span>
                                    {{ branch }} Department
                                </h3>
                            </div>
                            <div class="grid grid-cols-1 gap-1">
                                {% for subject in subjects %}
                                <div class="relative group subject-item rounded-lg transition-all" data-search="{{ subject.code }} {{ subject.name }} {{ branch }}" data-branch="{{ branch }}" data-semester="{{ subject.semester }}">
                                    <input type="checkbox" name="subject_ids" value="{{ subject.id }}" id="sub_{{ subject.id }}" class="peer absolute opacity-0 w-full h-full cursor-pointer z-10" />
                                    <div class="p-3 bg-white border border-gray-100 rounded-lg peer-checked:border-primary peer-checked:ring-1 peer-checked:ring-primary peer-checked:bg-primary/5 flex items-center gap-3 transition-all group-hover:border-primary/50">
                                        <div class="w-4 h-4 rounded border border-gray-300 group-has-[input:checked]:bg-primary group-has-[input:checked]:border-primary flex items-center justify-center transition-colors">
                                            <i data-feather="check" class="w-3 h-3 text-white opacity-0 group-has-[input:checked]:opacity-100"> </i>
                                        </div>

                                        <div class="flex-1 min-w-0">
                                            <div class="flex items-center justify-between">
                                                <span class="font-bold text-sm text-text-dark peer-checked:text-primary truncate mr-2"> {{ subject.code.split('-', 1)[1] if '-' in subject.code else subject.code }} : {{ subject.name }} </span>
                                                <span class="text-[10px] font-bold px-1.5 py-0.5 rounded bg-gray-100 text-text-light peer-checked:bg-primary/10 peer-checked:text-primary">Sem {{ subject.semester }}</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endfor %}
                        <div id="noSubjectsFound" class="hidden flex flex-col items-center justify-center h-full text-center py-8">
                            <div class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center mb-3">
                                <i data-feather="filter" class="w-5 h-5 text-gray-400"></i>
                            </div>
                            <p class="text-text-dark font-medium text-sm">No subjects match your filters</p>
                            <p class="text-xs text-text-light mt-1">Try adjusting your search criteria</p>
                        </div>
                    </div>
                </div>

                <!-- Section Input and Submit -->
                <div class="flex-shrink-0 grid grid-cols-1 md:grid-cols-3 gap-4 pt-2">
                    <div class="md:col-span-2">
                        <label class="sr-only" for="section">Section</label>
                        <input
                            type="text"
                            name="section"
                            id="section"
                            placeholder="Enter Section / Group (Optional)"
                            class="w-full bg-gray-50 border border-transparent rounded-xl px-4 py-3 text-text-dark font-medium focus:bg-white focus:border-primary focus:ring-2 focus:ring-primary/10 transition-all text-sm"
                        />
                    </div>
                    <button type="submit" class="w-full bg-primary text-white px-6 py-3 rounded-xl hover:bg-primary-dark font-bold shadow-lg shadow-primary/20 transition-all hover:scale-[1.02] active:scale-[0.98] flex justify-center items-center gap-2">
                        <i data-feather="check-square" class="w-4 h-4"></i> Assign
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Data & Scripts -->
    <script id="teacher-assignments-data" type="application/json">
        {{ teacher_assignments|default({})|tojson|safe }}
    </script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            if (typeof feather !== "undefined") {
                feather.replace();
            }

            // Logic copied from original file to ensure functionality
            const subjectSearch = document.getElementById("subjectSearchInput");
            const branchFilter = document.getElementById("branchFilter");
            const semesterFilter = document.getElementById("semesterFilter");
            const teacherSelect = document.getElementById("teacher_id");
            const subjectItems = document.querySelectorAll(".subject-item");
            const branchGroups = document.querySelectorAll(".branch-group");
            const noSubjectsMsg = document.getElementById("noSubjectsFound");
            const teacherAssignments = JSON.parse(document.getElementById("teacher-assignments-data").textContent);

            function filterSubjects() {
                const term = subjectSearch.value.toLowerCase();
                const selectedBranch = branchFilter.value;
                const selectedSemester = semesterFilter.value;
                const selectedTeacherId = parseInt(teacherSelect.value) || 0;
                const assignedSubjectIds = teacherAssignments[selectedTeacherId] || [];
                let hasVisibleSubjects = false;

                subjectItems.forEach((item) => {
                    const text = item.getAttribute("data-search").toLowerCase();
                    const branch = item.getAttribute("data-branch");
                    const semester = item.getAttribute("data-semester");
                    const checkbox = item.querySelector("input[type='checkbox']");
                    const subjectId = parseInt(checkbox.value);

                    const matchesSearch = text.includes(term);
                    const matchesBranch = !selectedBranch || branch === selectedBranch;
                    const matchesSemester = !selectedSemester || semester === selectedSemester;
                    const isAlreadyAssigned = assignedSubjectIds.includes(subjectId);

                    if (matchesSearch && matchesBranch && matchesSemester && !isAlreadyAssigned) {
                        item.classList.remove("hidden");
                        checkbox.disabled = false;
                        hasVisibleSubjects = true;
                    } else {
                        item.classList.add("hidden");
                        if (isAlreadyAssigned) {
                            checkbox.checked = false;
                            // Ensure style updates if using peer-checked
                            // Checkbox change event might not fire programmatically so we rely on CSS peer
                        }
                    }
                });

                branchGroups.forEach((group) => {
                    const visibleChildren = group.querySelectorAll(".subject-item:not(.hidden)");
                    group.classList.toggle("hidden", visibleChildren.length === 0);
                });

                if (!hasVisibleSubjects) {
                    noSubjectsMsg.classList.remove("hidden");
                    const p = noSubjectsMsg.querySelector("p");
                    if (p) {
                        if (selectedTeacherId && !term && !selectedBranch && !selectedSemester) {
                            p.textContent = "All available subjects are already assigned to this teacher.";
                        } else {
                            p.textContent = "No subjects match your filters";
                        }
                    }
                } else {
                    noSubjectsMsg.classList.add("hidden");
                }
            }

            subjectSearch.addEventListener("input", filterSubjects);
            branchFilter.addEventListener("change", filterSubjects);
            semesterFilter.addEventListener("change", filterSubjects);
            teacherSelect.addEventListener("change", filterSubjects);

            // Assignment search
            const assignmentSearch = document.getElementById("assignmentSearchInput");
            const assignmentCards = document.querySelectorAll(".assignment-card");
            const noAssignmentsMsg = document.getElementById("noAssignmentsFound");

            if (assignmentSearch) {
                assignmentSearch.addEventListener("input", function (e) {
                    const term = e.target.value.toLowerCase();
                    let hasVisible = false;
                    assignmentCards.forEach((card) => {
                        if (card.getAttribute("data-search").toLowerCase().includes(term)) {
                            card.classList.remove("hidden");
                            hasVisible = true;
                        } else {
                            card.classList.add("hidden");
                        }
                    });
                    noAssignmentsMsg.classList.toggle("hidden", hasVisible);
                });
            }
        });
    </script>
</div>
{% endblock %}
