{% extends "base.html" %} {% block title %}Calendar | Student{% endblock %} {% block content %}
<section class="max-w-7xl mx-auto space-y-8">
    <!-- Header -->
    <div class="flex items-end justify-between">
        <div>
            <h1 class="text-3xl font-bold text-text-dark">Academic Calendar</h1>
            <p class="text-text-light mt-1">Schedule, events, and important deadlines</p>
        </div>
        <div class="flex items-center gap-2">
            <button id="prevMonth" class="w-10 h-10 rounded-xl bg-white border border-gray-100 flex items-center justify-center hover:bg-gray-50 hover:shadow-md transition-all text-text-light">
                <i data-feather="chevron-left" class="w-5 h-5"></i>
            </button>
            <div id="monthYear" class="h-10 px-6 rounded-xl bg-white border border-gray-100 flex items-center justify-center font-bold text-text-dark min-w-[160px] shadow-sm">
                <!-- JS Injected -->
            </div>
            <button id="nextMonth" class="w-10 h-10 rounded-xl bg-white border border-gray-100 flex items-center justify-center hover:bg-gray-50 hover:shadow-md transition-all text-text-light">
                <i data-feather="chevron-right" class="w-5 h-5"></i>
            </button>
        </div>
    </div>

    <!-- Main Calendar Card (Full Width) -->
    <div class="bg-white rounded-3xl border border-gray-100 shadow-sm p-8">
        <!-- Legend (Full Width Grid) -->
        <div class="flex flex-wrap items-center gap-x-8 gap-y-4 mb-8 pb-6 border-b border-gray-100">
            <span class="text-xs font-bold text-text-lighter uppercase tracking-wider">Legend:</span>
            <div class="flex items-center gap-2">
                <span class="w-3 h-3 rounded-full bg-indigo-500"></span>
                <span class="text-sm text-text-light font-medium">Academic</span>
            </div>
            <div class="flex items-center gap-2">
                <span class="w-3 h-3 rounded-full bg-green-500"></span>
                <span class="text-sm text-text-light font-medium">Holiday</span>
            </div>
            <div class="flex items-center gap-2">
                <span class="w-3 h-3 rounded-full bg-amber-500"></span>
                <span class="text-sm text-text-light font-medium">Exam</span>
            </div>
            <div class="flex items-center gap-2">
                <span class="w-3 h-3 rounded-full bg-red-500"></span>
                <span class="text-sm text-text-light font-medium">Deadline</span>
            </div>
            <div class="flex items-center gap-2">
                <span class="w-3 h-3 rounded-full bg-primary border border-white shadow-sm"></span>
                <span class="text-sm text-text-light font-medium">Today</span>
            </div>
        </div>

        <!-- Days Header -->
        <div class="grid grid-cols-7 gap-2 mb-4">
            <div class="text-center text-xs font-bold text-text-lighter uppercase tracking-wider py-2">Sun</div>
            <div class="text-center text-xs font-bold text-text-lighter uppercase tracking-wider py-2">Mon</div>
            <div class="text-center text-xs font-bold text-text-lighter uppercase tracking-wider py-2">Tue</div>
            <div class="text-center text-xs font-bold text-text-lighter uppercase tracking-wider py-2">Wed</div>
            <div class="text-center text-xs font-bold text-text-lighter uppercase tracking-wider py-2">Thu</div>
            <div class="text-center text-xs font-bold text-text-lighter uppercase tracking-wider py-2">Fri</div>
            <div class="text-center text-xs font-bold text-text-lighter uppercase tracking-wider py-2">Sat</div>
        </div>

        <!-- Calendar Grid -->
        <div id="calendarDays" class="grid grid-cols-7 gap-2 min-h-[500px]">
            <!-- JS Injected -->
        </div>
    </div>
</section>
{% endblock %} {% block sidebar_content %}
<div class="space-y-6">
    <!-- Today's Focus -->
    <div class="bg-white rounded-2xl border border-gray-100 p-5 shadow-sm">
        <h3 class="text-xs font-bold text-text-lighter uppercase tracking-wider mb-4">On Agenda Today</h3>
        <div id="todayEvents" class="space-y-2">
            <!-- JS Injected -->
        </div>
    </div>

    <!-- Upcoming Events (Tabular) -->
    <div class="bg-white rounded-2xl border border-gray-100 p-5 shadow-sm overflow-hidden">
        <h3 class="text-xs font-bold text-text-lighter uppercase tracking-wider mb-4 flex items-center gap-2"><i data-feather="calendar" class="w-3 h-3"></i> Upcoming</h3>
        <div class="overflow-x-auto">
            <table class="w-full">
                <tbody id="eventList" class="text-sm">
                    <!-- JS Injected -->
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %} {% block scripts %}
<script id="template-data" type="application/json">
    {
        "calendarEvents": {{ calendar_events | tojson | safe }}
    }
</script>

<script>
    function getTemplateData() {
        try {
            const dataScript = document.getElementById("template-data");
            return JSON.parse(dataScript.textContent);
        } catch (e) {
            console.warn("Could not parse template data:", e);
            return {};
        }
    }

    const templateData = getTemplateData();
    const events = templateData ? templateData.calendarEvents : {};

    document.addEventListener("DOMContentLoaded", function () {
        if (typeof feather !== "undefined") {
            feather.replace();
        }

        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();

        const monthYearEl = document.getElementById("monthYear");
        const calendarDaysEl = document.getElementById("calendarDays");
        const prevBtn = document.getElementById("prevMonth");
        const nextBtn = document.getElementById("nextMonth");

        function renderCalendar(month, year) {
            calendarDaysEl.innerHTML = "";
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];

            monthYearEl.textContent = `${monthNames[month]} ${year}`;

            // Empty cells
            for (let i = 0; i < firstDay; i++) {
                calendarDaysEl.appendChild(document.createElement("div"));
            }

            const today = new Date();

            for (let d = 1; d <= daysInMonth; d++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, "0")}-${String(d).padStart(2, "0")}`;
                const isToday = year === today.getFullYear() && month === today.getMonth() && d === today.getDate();
                const hasEvent = events && events[dateStr];

                const dayEl = document.createElement("div");
                // Base classes - Increased font size, removed some padding to fit larger font
                let classes = "aspect-square rounded-2xl flex flex-col items-center justify-start pt-3 relative transition-all duration-200 cursor-default group ";

                if (isToday) {
                    classes += "bg-primary text-white shadow-lg shadow-primary/30 font-bold ";
                } else {
                    classes += "bg-gray-50/50 text-text-dark hover:bg-gray-100 ";
                }

                dayEl.className = classes;

                // Day Number - Larger Font
                const numSpan = document.createElement("span");
                numSpan.textContent = d;
                numSpan.className = "z-10 text-xl font-bold";
                dayEl.appendChild(numSpan);

                // Event Indicator
                if (hasEvent) {
                    const dot = document.createElement("div");
                    if (isToday) {
                        dot.className = "w-1.5 h-1.5 rounded-full bg-white absolute bottom-4 opacity-80";
                    } else {
                        dot.className = "w-1.5 h-1.5 rounded-full bg-amber-500 absolute bottom-4";
                    }
                    dayEl.appendChild(dot);
                    dayEl.title = events[dateStr];

                    // Tooltip
                    const hint = document.createElement("div");
                    hint.className = "absolute hidden group-hover:block bottom-full left-1/2 -translate-x-1/2 mb-2 w-max max-w-[150px] bg-gray-800 text-white text-[10px] px-2 py-1 rounded-lg z-20 pointer-events-none";
                    hint.textContent = events[dateStr];
                    dayEl.appendChild(hint);
                }

                calendarDaysEl.appendChild(dayEl);
            }
        }

        // Upcoming Events - Tabular Format
        function renderUpcoming() {
            const listEl = document.getElementById("eventList");
            const today = new Date();
            const upcoming = [];

            Object.keys(events).forEach((dateStr) => {
                const d = new Date(dateStr);
                if (d >= today) {
                    upcoming.push({ date: d, title: events[dateStr] });
                }
            });

            upcoming.sort((a, b) => a.date - b.date);
            const display = upcoming.slice(0, 5);

            listEl.innerHTML = "";
            if (display.length === 0) {
                listEl.innerHTML = `<tr><td class="text-xs text-text-light italic py-2">No upcoming events found.</td></tr>`;
                return;
            }

            display.forEach((ev) => {
                const tr = document.createElement("tr");
                tr.className = "border-b border-gray-50 last:border-0 hover:bg-gray-50 transition-colors group";

                // Formatted Date
                const dateString = ev.date.toLocaleDateString("en-US", { month: "short", day: "numeric" });

                tr.innerHTML = `
                    <td class="py-3 pr-2 align-middle w-full">
                        <div class="text-xs font-bold text-text-dark line-clamp-2" title="${ev.title}">${ev.title}</div>
                    </td>
                    <td class="py-3 pl-2 text-right align-middle whitespace-nowrap">
                         <span class="text-[10px] font-bold text-text-light bg-gray-50 border border-gray-100 px-2 py-1 rounded-lg group-hover:bg-white group-hover:border-primary/20 transition-colors">
                            ${dateString}
                        </span>
                    </td>
                 `;
                listEl.appendChild(tr);
            });
        }

        // Today Events
        function renderToday() {
            const todayContainer = document.getElementById("todayEvents");
            const todayStr = new Date().toISOString().split("T")[0];

            if (events[todayStr]) {
                todayContainer.innerHTML = `
                    <div class="bg-primary/5 p-3 rounded-xl border border-primary/10 flex items-start gap-3">
                        <i data-feather="bell" class="w-4 h-4 text-primary mt-0.5"></i>
                        <div>
                            <span class="text-sm font-bold text-primary block">${events[todayStr]}</span>
                            <span class="text-[10px] text-text-light">Happening today</span>
                        </div>
                    </div>
                 `;
                feather.replace();
            } else {
                todayContainer.innerHTML = `<span class="text-xs text-text-light">No events scheduled for today.</span>`;
            }
        }

        // Setup
        renderCalendar(currentMonth, currentYear);
        renderUpcoming();
        renderToday();

        // Listeners
        prevBtn.addEventListener("click", () => {
            currentMonth--;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            renderCalendar(currentMonth, currentYear);
        });

        nextBtn.addEventListener("click", () => {
            currentMonth++;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            renderCalendar(currentMonth, currentYear);
        });
    });
</script>
{% endblock %}
